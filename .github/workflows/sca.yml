name: Software Composition Analysis

on:
  workflow_dispatch:
    inputs:
      repository_url:
        description: 'Git repository URL to clone'
        required: true
        type: string

jobs:
  sca:
    runs-on: ubuntu-latest

    steps:
    # Step 1: Clone the Repository
    - name: Clone Repository
      run: |
        git clone ${{ inputs.repository_url }} repo

    # Step 2: Install Syft and Grype
    - name: Install Syft and Grype
      run: |
        curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
        curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin

    # Step 3: Generate SBOM using Syft
    - name: Generate SBOM
      run: |
        cd repo
        /usr/local/bin/syft version
        /usr/local/bin/syft . -v -o json > sbom.json
        ls -la

    # Step 4: Scan SBOM Using Grype
    - name: Scan SBOM with Grype
      run: |
        cd repo
        /usr/local/bin/grype version
        /usr/local/bin/grype sbom:sbom.json -v -o json > grype-report.json

    # Step 5: Upload the Grype report as an artifact
    - name: Upload Grype Report to Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: grype-report
        path: repo/grype-report.json
